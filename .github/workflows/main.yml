name: Convert DMG to ZIP

on:
  workflow_dispatch: # 允许手动触发执行

jobs:
  convert:
    runs-on: macos-latest # 使用 macOS 环境，因为自带 hdiutil 处理 dmg 非常方便
    
    steps:
      - name: Get Latest Obsidian Version
        id: get_version
        run: |
          # 获取最新版本号和下载链接
          LATEST_URL=$(curl -s https://api.github.com/repos/obsidianmd/obsidian-releases/releases/latest | grep "browser_download_url.*universal.dmg" | cut -d '"' -f 4 | head -n 1)
          echo "url=$LATEST_URL" >> $GITHUB_OUTPUT
          echo "下载链接: $LATEST_URL"

      - name: Download DMG
        run: |
          curl -L -o obsidian.dmg "${{ steps.get_version.outputs.url }}"

      - name: Extract DMG
        run: |
          # 挂载 DMG 镜像
          hdiutil attach obsidian.dmg
          # 将里面的 .app 复制出来（路径通常在 /Volumes/Obsidian...）
          # 我们使用通配符匹配挂载目录
          cp -R /Volumes/Obsidian*/Obsidian.app ./Obsidian.app
          # 卸载镜像
          hdiutil detach /Volumes/Obsidian*

      - name: Create ZIP
        run: |
          zip -r Obsidian-macOS.zip Obsidian.app

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Obsidian-ZIP-Package
          path: Obsidian-macOS.zip
          retention-days: 1 # 下载完后可以自动删除
