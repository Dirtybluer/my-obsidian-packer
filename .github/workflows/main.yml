name: Convert DMG to ZIP

on:
  workflow_dispatch: 

jobs:
  convert:
    runs-on: macos-latest 
    
    steps:
      - name: Get Latest Obsidian Version
        id: get_version
        run: |
          # 使用 jq 查找所有以 .dmg 结尾的任务，并选择第一个
          # 如果你的 Mac 是 M1/M2/M3 芯片（Apple Silicon），可以优先找 arm64
          # 这里我们找最通用的 .dmg
          LATEST_URL=$(curl -s https://api.github.com/repos/obsidianmd/obsidian-releases/releases/latest | jq -r '.assets[] | select(.name | endswith(".dmg")) | .browser_download_url' | head -n 1)
          
          if [ -z "$LATEST_URL" ] || [ "$LATEST_URL" == "null" ]; then
            echo "错误：未能获取下载链接"
            exit 1
          fi
          
          echo "url=$LATEST_URL" >> $GITHUB_OUTPUT
          echo "Found URL: $LATEST_URL"

      - name: Download DMG
        run: |
          curl -L -o obsidian.dmg "${{ steps.get_version.outputs.url }}"

      - name: Extract DMG
        run: |
          # 挂载
          hdiutil attach obsidian.dmg -mountpoint ./obsidian_mount
          
          # 查找挂载目录下的 .app 并复制
          # 使用 -R 保留软链接和权限
          cp -R ./obsidian_mount/*.app ./Obsidian.app
          
          # 卸载
          hdiutil detach ./obsidian_mount

      - name: Create ZIP
        run: |
          zip -ry Obsidian-macOS.zip Obsidian.app

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Obsidian-ZIP-Package
          path: Obsidian-macOS.zip
          retention-days: 1
